# Configuration direnv pour Pexiora TT
source_up_if_exists
watch_file package.json
watch_file .nvmrc
watch_file .husky

# --- Configuration NVM (Node Version Manager) ---

export NVM_DIR="$HOME/.nvm"
NVM_LOADED=0

# Tente de charger NVM si le script existe
if [ -s "$NVM_DIR/nvm.sh" ]; then
    . "$NVM_DIR/nvm.sh"
    NVM_LOADED=1
else
    echo "ATTENTION : Script nvm.sh non trouv√© dans $NVM_DIR. V√©rifiez votre installation NVM."
fi

# Utiliser NVM pour activer la version Node (si NVM a √©t√© charg√©)
if [ $NVM_LOADED -eq 1 ]; then
    if [ -f ".nvmrc" ]; then
        nvm use --silent
    else
        # Fallback sur la version par d√©faut si .nvmrc est absent
        nvm use default --silent
    fi
elif [ -f ".nvmrc" ]; then
    echo "INFO: .nvmrc trouv√©, mais NVM n'a pas pu √™tre charg√© pour l'utiliser."
fi

# --- D√©pendances Node.js (pnpm) & Configuration de l'environnement ---

# Le layout node est maintenant g√©r√© par NVM, mais on le garde pour l'acc√®s aux binaires locaux.
# Le layout node peut aussi installer Node, mais ici on d√©pend de NVM pour la version.
# Si tu souhaites que direnv g√®re la version sans NVM, retire la section NVM et utilise seulement `layout node`.
# Si tu gardes NVM (Recommand√©), on peut se passer de `layout node`.

# Configuration des binaires locaux (pour netlify-cli, prettier, etc.)
PATH_add node_modules/.bin

# V√©rifier la pr√©sence de pnpm (requis pour l'installation)
if ! command -v pnpm &> /dev/null; then
    echo "‚ùå pnpm n'est pas install√©. Installez-le avec:"
    echo "   - brew install pnpm"
    return 1
fi

# V√©rification et installation des d√©pendances Node.js avec pnpm
# On v√©rifie seulement la pr√©sence du r√©pertoire pour un gain de temps,
# pnpm g√®re ensuite l'incr√©mentalit√©.
if [ -f "package.json" ]; then
    echo "V√©rification et installation des d√©pendances Node.js avec pnpm..."
    pnpm install --silent

    # ‚ö†Ô∏è V√©rifie apr√®s l'installation si node_modules/.bin est bien l√†
    if [ ! -d "node_modules/.bin" ]; then
        echo "ATTENTION : node_modules/.bin n'a pas √©t√© cr√©√© correctement apr√®s pnpm install."
    fi
fi

# --- V√©rifications des Outils Syst√®mes (Zola, etc.) ---

# Simplification : Les v√©rifications de d√©pendances Node.js et Node.js lui-m√™me
# sont implicitement faites par la section NVM et pnpm.

# V√©rifier la pr√©sence de Zola
if ! command -v zola &> /dev/null; then
# ... (Instructions d'installation Zola)
    echo "‚ùå Zola n'est pas install√©."
    echo "üìñ Consultez la documentation d'installation :"
    echo "   https://www.getzola.org/documentation/getting-started/installation/"
    echo ""
    echo "üöÄ Installation rapide :"
    echo "   - brew install zola"
    echo ""
    return 1
fi

# V√©rifier la pr√©sence de just
if ! command -v just &> /dev/null; then
# ... (Instructions d'installation Just)
    echo "‚ùå just n'est pas install√©. Installez-le avec:"
    echo "   - cargo install just (si vous avez Rust install√©)"
    echo "   - brew install just"
    echo "   Puis red√©marrez votre shell"
    return 1
fi

# V√©rifier la pr√©sence de bats
if ! command -v bats &> /dev/null; then
# ... (Instructions d'installation BATS)
    echo "‚ùå bats n'est pas install√©. Installez-le avec:"
    echo "   - brew install bats-core"
    echo "   Puis red√©marrez votre shell"
    return 1
fi

# --- Finalisation et Messages ---

# Fonction pour netlify dev (export√©e)
netlify_dev() {
    echo "üöÄ D√©marrage de netlify dev..."
    # Utilise 'pnpm exec' pour garantir que netlify-cli est bien trouv√©
    pnpm exec netlify dev --live
}

export -f netlify_dev

echo "‚úÖ Environnement Pexiora TT pr√™t !"
echo "üí° Commandes disponibles :"
echo "   just dev    - D√©marrer le serveur de d√©veloppement"
echo "   just build  - Construire le site"
echo "   just check  - V√©rifier la qualit√© du code"
echo "   just test   - Lancer les tests"

# V√©rifier les versions
echo ""
echo "üîß Versions install√©es :"
echo "   Zola: $(zola --version)"
echo "   Node.js: $(node --version 2>/dev/null || echo "Non charg√©/Install√©")"
echo "   pnpm: $(pnpm --version 2>/dev/null || echo "Non install√©")"
echo "   Netlify CLI: $(pnpm exec netlify --version 2>/dev/null || echo "Non install√©")"
echo "   Just: $(just --version 2>/dev/null || echo "Non install√©")"
