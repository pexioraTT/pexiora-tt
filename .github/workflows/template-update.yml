name: ðŸ”„ Mise Ã  jour Template

on:
  schedule:
    # ExÃ©cuter chaque lundi Ã  9h00 UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

jobs:
  update-template:
    name: ðŸ”„ VÃ©rifier les mises Ã  jour du template
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"

      - name: ðŸ Configuration Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: ðŸ“¦ Installation de cruft
        run: pip install cruft

      - name: ðŸ” VÃ©rification des mises Ã  jour disponibles
        id: check
        run: |
          if cruft check; then
            echo "up_to_date=true" >> $GITHUB_OUTPUT
            echo "âœ… Template Ã  jour"
          else
            echo "up_to_date=false" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Mises Ã  jour disponibles"
          fi

      - name: ðŸ”„ Mise Ã  jour du template
        if: steps.check.outputs.up_to_date == 'false'
        run: |
          # Configurer git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # CrÃ©er une branche pour les mises Ã  jour
          git checkout -b template-update-$(date +%Y%m%d)

          # Appliquer les mises Ã  jour
          cruft update --skip-apply-ask || true

          # VÃ©rifier s'il y a des changements
          if git diff --quiet; then
            echo "Aucun changement aprÃ¨s la mise Ã  jour"
            exit 0
          fi

          # Commiter les changements
          git add .
          git commit -m "ðŸ”„ Mise Ã  jour automatique du template

          - Mise Ã  jour via cruft
          - ExÃ©cutÃ©e automatiquement par GitHub Actions
          - Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # Pousser la branche
          git push origin template-update-$(date +%Y%m%d)

      - name: ðŸ“ CrÃ©er une Pull Request
        if: steps.check.outputs.up_to_date == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, owner } = context.repo;
            const branchName = `template-update-${new Date().toISOString().slice(0, 10).replace(/-/g, '')}`;

            try {
              const result = await github.rest.pulls.create({
                title: 'ðŸ”„ Mise Ã  jour automatique du template',
                owner,
                repo,
                head: branchName,
                base: 'main',
                body: `## ðŸ”„ Mise Ã  jour automatique du template

                Cette PR contient les mises Ã  jour automatiques du template Zola.

                ### âš ï¸ Actions requises
                - [ ] VÃ©rifier les changements
                - [ ] Tester localement si nÃ©cessaire
                - [ ] Merger si tout est OK

                ### ðŸ“‹ DÃ©tails
                - **Source**: Template Zola mis Ã  jour
                - **Outil**: cruft
                - **Date**: ${new Date().toISOString()}
                - **Automatique**: Oui

                ### ðŸ” VÃ©rifications
                - Les workflows CI passeront automatiquement
                - VÃ©rifiez que le site se build correctement
                - Testez les nouvelles fonctionnalitÃ©s si applicable

                ---
                *Cette PR a Ã©tÃ© crÃ©Ã©e automatiquement par GitHub Actions*`
              });

              console.log('Pull Request crÃ©Ã©e:', result.data.html_url);
            } catch (error) {
              console.log('Erreur lors de la crÃ©ation de la PR:', error.message);
            }

      - name: ðŸ“Š Rapport
        run: |
          echo "## ðŸ”„ Rapport de mise Ã  jour du template" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.up_to_date }}" == "true" ]; then
            echo "âœ… **Template Ã  jour** - Aucune action requise" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ”„ **Mise Ã  jour disponible** - PR crÃ©Ã©e automatiquement" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Actions suivantes" >> $GITHUB_STEP_SUMMARY
            echo "1. VÃ©rifier la PR crÃ©Ã©e" >> $GITHUB_STEP_SUMMARY
            echo "2. Tester les changements" >> $GITHUB_STEP_SUMMARY
            echo "3. Merger si tout est OK" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date de vÃ©rification**: $(date -u)" >> $GITHUB_STEP_SUMMARY
